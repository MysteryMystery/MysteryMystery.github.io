@page "/CloutShoots/{year:int?}"

@inject ICloutShootsService CloutShootsService
@inject ILogger<CloutShoots> Logger;

<PageTitle>Clout Shoots</PageTitle>

<div class="container mx-auto py-2">
    @if (Shoots is not null)
    {
            <div class="flex justify-center">
                <Pagination>
                    @foreach(int year in validYears)
                    {
                        <PaginationItem Href="@("/CloutShoots/" + year)" IsActive=@(year == Year)>
                            @year
                        </PaginationItem>
                    }
                </Pagination>
            </div>

            <div class="grid grid-cols-3 md:grid-cols-5 w-full gap-4 m-3 text-center font-bold">
                <div class="px-6 py-3 text-xl">Venue</div>
                <div class="px-6 py-3 text-xl">Round</div>
                <div class="px-6 py-3 text-xl">Date</div>
                <div class="px-6 py-3 text-xl">Form</div>
                <div class="px-6 py-3 text-xl">Maps</div>
            </div>

            @foreach (var cloutShoot in Shoots)
            {
                <div class="grid grid-cols-3 md:grid-cols-5 w-full gap-4 py-4 text-center odd:bg-light even:bg-slate-100 @(IsPastDate(cloutShoot.Date) ? "text-slate-600" : "")">
                    <div class="px-2 font-bold text-lg text-left col-span-2 md:col-span-1">@((MarkupString)cloutShoot.Name)</div>
                    <div>@(cloutShoot.Name.Contains("*") ? "Imperial" : "Metric")</div>
                    <div>@cloutShoot.Date.ToString("dd/MM/yyyy")</div>
                    <div>
                        @if (cloutShoot.FormUrl is not null)
                        {
                            <Blazor.Shared.Components.Btn Href="@cloutShoot.FormUrl" ButtonType="primary" Target="_blank">
                                Form
                            </Blazor.Shared.Components.Btn>
                        }
                    </div>
                    <div>
                        @if (cloutShoot.MapUrl is not null)
                        {
                            <Blazor.Shared.Components.Btn Href="@cloutShoot.MapUrl" ButtonType="secondary" Target="_blank">
                                Map
                            </Blazor.Shared.Components.Btn>
                        }
                    </div>
                </div>
            }
    }
</div>

@code {
    [CascadingParameter]
    public MainLayout MainLayout { get; set; }

    [Parameter]
    public int? Year { get; set; }
    private int? previousYear;

    private IEnumerable<CloutShoot> _cloutShoots = new CloutShoot[0];

    private IEnumerable<CloutShoot> Shoots {
        get => _cloutShoots;
        set {
            _cloutShoots = value;
        }
    }
    private List<int> validYears = new List<int>();

    private DateOnly dateToday = DateOnly.FromDateTime(DateTime.Now);

    protected override async Task OnInitializedAsync()
    {
        MainLayout.ShowNavbar = true;

        validYears = CloutShootsService.GetYears().ToList();
    }

    // Being called twice, 
    // one with previous year 
    // one with new year
    // race condition
    protected async override Task OnParametersSetAsync()
    {
        await base.OnParametersSetAsync();

        if(Year is null)
        {
            Logger.LogInformation("setting year to: " + dateToday.Year.ToString());
            Year = dateToday.Year;
        }

        if(Year != previousYear){
            previousYear = Year;

            Logger.LogInformation("Year to retrieve: " + Year);

            Shoots = await CloutShootsService.GetCloutShoots(Year.Value);
            Logger.LogInformation("Number of shoots retrieved for year " + Year + ": " + Shoots.Count());
        }
    }

    private bool IsPastDate(DateTime d) => dateToday > DateOnly.FromDateTime(d);
}