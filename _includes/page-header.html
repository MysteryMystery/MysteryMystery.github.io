<nav id="page-header" class="navbar navbar-expand-md navbar-dark custom-nav align-items-start">
    <div class="d-flex flex-col flex-wrap justify-content-start align-items-stretch hero-bar py-1">
        <div id="avatar-wrapper border-danger" class="p-md-3">
            <a href="{{ site.url }}">
                <img src="/img/avatar.jpg" class="rounded-circle avatar-img border-primary" style="height: auto; width: auto; max-height: 10rem;">
            </a>
        </div>
        <div id="contact-wrapper" class="h-100">
            <div id="author-email" class="p-md-1 px-md-3 d-flex flex-column">
                <p class="my-0 lead fs-3 text-light">{{ site.author }}</p>
                <p class="my-0 lead fs-4 text-primary">{{ site.email }}</p>
            </div>
            {% include hr.html class="bg-primary" %}
        </div>
    </div>

    <div class="flex-grow-1 d-flex justify-content-end">
        {% include navbar.html %}
    </div>
</nav>

<script>
    function remToPx(rem){
        return rem * parseFloat(getComputedStyle(document.documentElement).fontSize);
    }

    window.addEventListener("load", function(){
        function createSpaceFiller(height){
            const div = document.createElement("div")
            div.id = "page-header-temp"
            div.style.height = height + "px";
            return div;
        }

        const getScrollSnapshots = selectors => selectors.map(x => 
            Array.from(parent.querySelectorAll(x)).map(y => ({
                    element: y,
                    initialHeight: y.offsetHeight,
                    minShrink: y.offsetHeight / 2
                })
            )
        ).flat()

        const navbar = document.querySelector("#page-header")
        const parent = navbar.parentElement
        const initialNavHeight = navbar.offsetHeight
        const minNavHeight = 70

        const navStickyClasses = ["position-fixed",  "min-vw-100"]
        navStickyClasses.forEach(x => navbar.classList.add(x))

        parent.appendChild(createSpaceFiller(initialNavHeight))
        const navFiller = parent.querySelector("#page-header-temp")

        
        const authorEmail = parent.querySelector("#contact-wrapper")

        const elementsToShrinkHeight = getScrollSnapshots([".avatar-img"])
        //const elementsToShrinkFont = getScrollSnapshots(["p", "a"])

        window.addEventListener("scroll", function(event){
            let x = initialNavHeight - this.scrollY + 3; // buffer for that whiteline that appears when scrolling quickly 
            if(x < minNavHeight)
                x = minNavHeight
            navbar.style.maxHeight = x + "px"

            let scrollY = this.scrollY
            elementsToShrinkHeight.forEach(o => {
                let d = (o.initialHeight - scrollY);
                if(d < o.minShrink)
                    d = o.minShrink
                o.element.style.maxHeight = d + "px"
            })

            if(x < minNavHeight * 1.5){
                authorEmail.style.opacity = 0;
                authorEmail.style.maxHeight = 0;
            } else {
                authorEmail.style.opacity = "unset";
                authorEmail.style.maxHeight = "unset";
            }
        })
    })
</script>